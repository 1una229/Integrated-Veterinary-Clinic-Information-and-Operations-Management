<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Pet Records - Paw Care</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    body{font-family:'Poppins',sans-serif}
    .shadow-soft{box-shadow:0 4px 16px rgba(0,0,0,.05)}
    :root{--soft-teal:#199e9e}
    .err{border-color:#ef4444 !important}
  </style>
</head>
<body class="bg-[#f6f9f9] min-h-screen flex flex-col">
  <!-- Header -->
  <header class="w-full bg-[var(--soft-teal)] text-white flex items-center justify-between px-12 py-4 shadow-soft">
    <div class="flex items-center space-x-5">
      <img src="assets/logo.png" class="w-14 h-14 rounded-lg bg-white p-1 object-contain" alt="">
      <div>
        <h1 class="text-2xl font-semibold">Paw Care Veterinary Clinic</h1>
        <p class="text-sm text-gray-100/90">Caring for your pets with compassion and expertise</p>
      </div>
    </div>
    <button class="bg-white text-[var(--soft-teal)] px-5 py-2 rounded-md font-semibold hover:bg-gray-50" onclick="logout()">Logout</button>
  </header>

  <div class="flex flex-1">
    <!-- Sidebar -->
    <aside class="w-72 bg-white border-r border-gray-200 p-6 shadow-soft">
      <h2 class="text-xl font-semibold text-[var(--soft-teal)] uppercase mb-4">Pet Records</h2>
      <nav id="sidebarNav" class="flex flex-col space-y-2"></nav>
    </aside>

    <!-- Main -->
    <main class="flex-1 p-8">
      <div class="bg-white rounded-2xl shadow-soft p-8">
        <div class="flex items-center justify-between mb-6">
          <h3 class="text-2xl font-semibold text-gray-800">All Pets</h3>

          <div class="flex items-center gap-2">
            <!-- NEW: Search by Microchip -->
            <input id="searchChip" class="border border-gray-300 rounded-md p-3 w-64" placeholder="Search by Microchip #">
            <button id="addBtn" class="bg-[var(--soft-teal)] text-white px-5 py-3 rounded-md hover:brightness-95">Add Record</button>
          </div>
        </div>

        <div class="overflow-x-auto">
          <table class="w-full border-collapse">
            <thead>
            <tr class="text-left text-gray-600 border-b">
              <th class="py-3">Photo</th>
              <th class="py-3">Pet Name</th>
              <th class="py-3">Owner</th>
              <th class="py-3">Microchip</th>
              <th class="py-3">Contact</th>
              <th class="py-3">Actions</th>
            </tr>
            </thead>
            <tbody id="rows"></tbody>
          </table>
        </div>
      </div>
    </main>
  </div>

  <!-- Modal root -->
  <div id="modalRoot"></div>

  <script src="assets/api.js"></script>
  <script src="assets/app.js"></script>
  <script>
    guard('pet-records');
    const role = getRole();
    renderSidebar(document.getElementById('sidebarNav'), role, 'pet-records.html');

    const rows = document.getElementById('rows');
    const modalRoot = document.getElementById('modalRoot');
    const searchChip = document.getElementById('searchChip');

    let PETS = []; // page-local cache

    /* ---------- Utils: numeric-only enforcers ---------- */
    const onlyDigits = (str) => (str||"").replace(/\D+/g,'');
    function attachDigitsOnly(el, maxLen=null){
      el.addEventListener('input', ()=>{
        let v = onlyDigits(el.value);
        if (maxLen) v = v.slice(0, maxLen);
        el.value = v;
      });
    }
    function valid11Digits(v){ return /^\d{11}$/.test(v); }

    /* ---------- Rendering ---------- */
    function cardPhoto(url){
      return url
        ? `<img src="${url}" class="w-12 h-12 object-cover rounded-md border">`
        : `<div class="w-12 h-12 rounded-md border bg-gray-100 grid place-items-center text-gray-400">No<img alt="" style="display:none"></div>`;
    }

    async function load(){
      PETS = await repoListPets();
      render();
    }

    function render(){
      const q = onlyDigits(searchChip.value).trim();
      const list = q ? PETS.filter(p => (p.microchip||'').includes(q)) : PETS;

      rows.innerHTML = list.map(p => `
        <tr class="border-b">
          <td class="py-3">${cardPhoto(p.photo)}</td>
          <td class="py-3">${p.name||''}</td>
          <td class="py-3">${p.owner||''}</td>
          <td class="py-3">${p.microchip||''}</td>
          <td class="py-3">${p.contactNumber || ''}</td>
          <td class="py-3">
            <button class="px-3 py-2 border rounded-md mr-2 hover:bg-gray-50" onclick="viewPet(${p.id})">View</button>
            <button class="px-3 py-2 border rounded-md mr-2 hover:bg-gray-50" onclick="editPet(${p.id})">Edit</button>
            <button class="px-3 py-2 border rounded-md text-red-600 hover:bg-red-50" onclick="delPet(${p.id})">Delete</button>
          </td>
        </tr>
      `).join('');
    }

    searchChip.addEventListener('input', render);

    /* ---------- Navigation ---------- */
    async function viewPet(id){ location.href = `pet-profile.html?id=${id}`; }

    /* ---------- Add / Edit Forms ---------- */
    document.getElementById('addBtn').addEventListener('click', ()=> openForm());

    async function editPet(id){
      const pet = PETS.find(x=>x.id===id);
      openForm(pet);
    }

    function openForm(existing=null){
      modalRoot.innerHTML = `
        <div class="fixed inset-0 bg-black/40 flex items-center justify-center p-4">
          <div class="bg-white rounded-2xl w-full max-w-2xl p-6">
            <h3 class="text-xl font-semibold mb-4">${existing?'Edit':'Add'} Pet Record</h3>

            <div class="grid md:grid-cols-2 gap-3">
              <label class="text-sm text-gray-600 block">Pet Name
                <input id="f_name" class="w-full border border-gray-300 rounded-md p-3 mt-1" value="${existing?.name||''}">
              </label>

              <label class="text-sm text-gray-600 block">Owner
                <input id="f_owner" class="w-full border border-gray-300 rounded-md p-3 mt-1" value="${existing?.owner||''}">
              </label>

              <!-- NEW: Contact Number (11 digits) -->
              <label class="text-sm text-gray-600 block">Contact Number (11 digits)
                <input id="f_contact" class="w-full border border-gray-300 rounded-md p-3 mt-1" placeholder="09xxxxxxxxx" value="${existing?.contactNumber||''}">
                <small id="c_err" class="text-xs text-red-600 hidden">Must be 11 digits.</small>
              </label>

              <!-- Microchip (numbers only) -->
              <label class="text-sm text-gray-600 block">Microchip #
                <input id="f_chip" class="w-full border border-gray-300 rounded-md p-3 mt-1" value="${existing?.microchip||''}">
                <small class="text-xs text-gray-500">Numbers only.</small>
              </label>

              <label class="text-sm text-gray-600 block">Species
                <select id="f_species" class="w-full border border-gray-300 rounded-md p-3 mt-1">
                  <option ${existing?.species==='Canine'?'selected':''}>Canine</option>
                  <option ${existing?.species==='Feline'?'selected':''}>Feline</option>
                </select>
              </label>

              <label class="text-sm text-gray-600 block">Breed
                <input id="f_breed" class="w-full border border-gray-300 rounded-md p-3 mt-1" value="${existing?.breed||''}">
              </label>

              <label class="text-sm text-gray-600 block">Gender
                <select id="f_gender" class="w-full border border-gray-300 rounded-md p-3 mt-1">
                  <option ${existing?.gender==='Male'?'selected':''}>Male</option>
                  <option ${existing?.gender==='Female'?'selected':''}>Female</option>
                </select>
              </label>

              <label class="text-sm text-gray-600 block">Age
                <input id="f_age" type="number" min="0" class="w-full border border-gray-300 rounded-md p-3 mt-1" value="${existing?.age||''}">
              </label>

              <label class="text-sm text-gray-600 block">Federation
                <select id="f_fed" class="w-full border border-gray-300 rounded-md p-3 mt-1">
                  <option ${existing?.federation==='FCCI'?'selected':''}>FCCI</option>
                  <option ${existing?.federation==='FCPI'?'selected':''}>FCPI</option>
                  <option ${existing?.federation==='N/A'?'selected':''}>N/A</option>
                </select>
              </label>

              <label class="text-sm text-gray-600 block md:col-span-2">Address
                <input id="f_addr" class="w-full border border-gray-300 rounded-md p-3 mt-1" value="${existing?.address||''}">
              </label>

              <!-- Photo -->
              <label class="text-sm text-gray-600 block md:col-span-2">Photo
                <input id="f_photo" type="file" accept="image/*" class="w-full border border-gray-300 rounded-md p-3 mt-1">
                <small class="text-xs text-gray-500">Upload a clear pet photo (JPG/PNG).</small>
              </label>
            </div>

            <div class="mt-5 flex justify-end gap-3">
              <button class="px-4 py-2 border rounded-md" onclick="closeModal()">Cancel</button>
              <button class="px-5 py-2 rounded-md bg-[var(--soft-teal)] text-white" onclick="savePet(${existing?existing.id:'null'})">Save</button>
            </div>
          </div>
        </div>`;

      // numeric-only enforcement
      const chip = document.getElementById('f_chip');
      attachDigitsOnly(chip, 30); // allow long chips but digits only

      const contact = document.getElementById('f_contact');
      attachDigitsOnly(contact, 11); // force 11 digits
      contact.addEventListener('input', ()=>{
        const ok = valid11Digits(contact.value);
        contact.classList.toggle('err', !ok && contact.value.length>0);
        document.getElementById('c_err').classList.toggle('hidden', ok || contact.value.length===0);
      });
    }

    function closeModal(){ modalRoot.innerHTML = ''; }

    async function savePet(existingId){
      const name = document.getElementById('f_name').value.trim();
      const owner = document.getElementById('f_owner').value.trim();
      const contactNumber = document.getElementById('f_contact').value.trim();
      const microchip = document.getElementById('f_chip').value.trim();
      const species = document.getElementById('f_species').value;
      const breed = document.getElementById('f_breed').value.trim();
      const gender = document.getElementById('f_gender').value;
      const age = Number(document.getElementById('f_age').value || 0);
      const federation = document.getElementById('f_fed').value;
      const address = document.getElementById('f_addr').value.trim();
      const file = document.getElementById('f_photo').files[0] || null;

      // validations
      let ok = true;
      const mark = (id, isOk)=>document.getElementById(id).classList.toggle('err', !isOk);
      mark('f_name', !!name);
      mark('f_owner', !!owner);

      // contact must be exactly 11 digits if provided
      const contactOk = contactNumber==='' ? true : valid11Digits(contactNumber);
      mark('f_contact', contactOk);
      document.getElementById('c_err').classList.toggle('hidden', contactOk);

      // microchip must be numeric (we already force digits-only; empty OK)
      const microOk = /^\d*$/.test(microchip);
      mark('f_chip', microOk);

      if (!name || !owner || !contactOk || !microOk) { return; }

      const payload = {
        id: existingId || undefined,
        name, owner, contactNumber, microchip, species, breed, gender, age, federation, address,
        photo: null, procedures: [] // photo handled below
      };

      try{
        if (existingId){
          // update
          payload.id = existingId;
          await repoUpdatePet(payload);
          // upload photo if chosen
          if (file) {
            if (window.USE_API) {
              await Api.pets.uploadPhoto(existingId, file);
            } else {
              const dataUrl = await fileToDataURL(file);
              // save to local
              const p = PETS.find(x=>x.id===existingId);
              if (p){ p.photo = dataUrl; await repoUpdatePet(p); }
            }
          }
        } else {
          // create
          const created = await repoAddPet(payload, file || null);
          if (!window.USE_API && file) {
            // local mode: store dataURL
            const dataUrl = await fileToDataURL(file);
            created.photo = dataUrl;
            await repoUpdatePet(created);
          }
        }

        closeModal();
        await load();
      } catch (e){
        alert("Save failed: " + (e?.message || e));
      }
    }

    async function delPet(id){
      if (!confirm('Delete this pet?')) return;
      await repoDeletePet(id);
      await load();
    }

    load();
  </script>
</body>
</html>
